<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hyaena</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e3dac9">
    <link rel="apple-touch-icon" href="icon.png">
    
    <style>
        /* STILI GENERALI */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: #222; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            display: flex; flex-direction: column; overflow: hidden;
            overscroll-behavior-y: none;
        }

        /* TOOLBAR */
        #toolbar {
            flex-shrink: 0; background: #fff; padding: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 1000;
            display: flex; flex-direction: column; gap: 8px;
        }

        .row { display: flex; justify-content: center; align-items: center; gap: 6px; flex-wrap: wrap; }

        /* BOTTONI */
        .btn {
            padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; background: #f2f2f7; 
            font-size: 13px; font-weight: 600; cursor: pointer; color: #333; display: flex; align-items: center; gap: 5px;
        }
        .btn.active { background-color: #007aff; color: white; border-color: #005bb5; }
        
        .btn-green { background-color: #34c759; color: white; border: none; } 
        .btn-blue { background-color: #007aff; color: white; border: none; } 
        .btn-red { background-color: #ff3b30; color: white; border: none; }
        .btn-calib { background-color: #ff9500; color: white; border: none; }
        .btn-excel { background-color: #1d6f42; color: white; border: none; }

        /* Tasto Modalit√† Dubbio */
        .btn-doubt-mode { border: 2px solid #ffd60a; background: #fffbe6; color: #b48900; }
        .btn-doubt-mode.active { background: #ffd60a; color: #000; border-color: #b48900; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 214, 10, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 214, 10, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 214, 10, 0); } }

        .btn-mark-doubt { background-color: #666; color: #ffd60a; border: 1px solid #ffd60a; }

        input[type="file"] { display: none; }
        .file-label { padding: 6px 10px; border-radius: 6px; background: #e5e5ea; font-size: 12px; cursor: pointer; border: 1px solid #ccc; }

        #zoomContainer { display: flex; align-items: center; gap: 5px; background: #f2f2f7; padding: 4px 8px; border-radius: 15px; border: 1px solid #ddd; }
        input[type=range] { width: 80px; }

        #stats-bar {
            background: #f9f9f9; padding: 6px; font-size: 12px; font-weight: 600;
            border-bottom: 1px solid #ccc; text-align: center; color: #333;
            display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;
        }

        /* VIEWPORT */
        #viewport {
            flex-grow: 1; overflow: auto; position: relative; background-color: #444;
            display: flex; align-items: center; justify-content: center; 
            touch-action: none; -webkit-overflow-scrolling: touch;
        }
        canvas { display: block; background: white; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        
        /* Cursori */
        .mode-pan canvas { cursor: grab; }
        .mode-draw canvas { cursor: crosshair; }
        .mode-select canvas { cursor: pointer; }
        .mode-measure canvas { cursor: crosshair; }

        #doubtOverlayMsg {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 214, 10, 0.95); color: black; padding: 8px 20px;
            border-radius: 20px; font-weight: bold; font-size: 13px; pointer-events: none; display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 500; border: 1px solid #b48900;
        }

        /* MODALE */
        #modalOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        #modalBox { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; }
        .modal-section { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .inp-num { padding: 8px; width: 80px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .inp-sel { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; background: white; }
    </style>
</head>
<body>

    <div id="toolbar">
        <div class="row">
            <label class="file-label">üì∑ Nuova<input type="file" id="inpFile" accept="image/*"></label>
            <label class="file-label">üìÇ Apri<input type="file" id="inpProject" accept=".json"></label>
            <button class="btn btn-blue" onclick="saveProject()">üíæ Salva</button>
            <button class="btn btn-green" onclick="downloadImg()">üñºÔ∏è JPG</button>
            <button class="btn btn-green" onclick="downloadImgWithCounts()">üì∏+üìä Info</button>
            <button class="btn btn-excel" onclick="exportExcel()">üìä Excel</button>
            <button class="btn btn-calib" onclick="openCalibration()">üìê Calibra</button>
        </div>

        <div class="row">
            <div id="zoomContainer">
                <span>üîç</span>
                <input type="range" id="zoomSlider" min="10" max="250" value="100" oninput="updateZoom(this.value)">
                <span id="zoomLabel" style="font-size:11px; width:30px;">100%</span>
            </div>
            <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>
            <button id="btnPan" class="btn active" onclick="setMode('pan')">‚úã Sposta</button>
            <button id="btnSelect" class="btn" onclick="setMode('select')">üëÜ Modifica</button>
            <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>
            <button id="btnDoubtMode" class="btn btn-doubt-mode" onclick="toggleDoubtMode()">‚ö†Ô∏è Mod. Dubbio</button>
        </div>

        <div class="row" id="toolsRow">
            <button id="toolLineFs" class="btn active" onclick="setDrawTool('line_fs')" style="border-left:5px solid #ff3b30">üìè Scratches</button>
            <button id="toolSp" class="btn" onclick="setDrawTool('point_sp')" style="border-left:5px solid #007aff">üîµ Sp</button>
            <button id="toolPp" class="btn" onclick="setDrawTool('point_pp')" style="border-left:5px solid #ff9500">üü† Pp</button>
            <button id="toolCircle" class="btn" onclick="setDrawTool('circle_auto')" style="border-left:5px solid #555">‚≠ï Auto</button>
            <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>
            <button id="btnMarkDoubt" class="btn btn-mark-doubt" onclick="markSelectedAsDoubt()" style="display:none;">‚ùì Segna Dubbio</button>
            <button id="btnDelete" class="btn btn-red" onclick="deleteSelected()" style="display:none;">üóëÔ∏è Elimina</button>
            <button class="btn" onclick="undo()" id="btnUndo">‚Ü© Annulla</button>
            <button class="btn" onclick="redo()" id="btnRedo">‚Ü™ Rifai</button>
        </div>
    </div>

    <div id="stats-bar">Carica foto e calibra.</div>

    <div id="viewport" class="mode-pan">
        <div id="doubtOverlayMsg">‚ö†Ô∏è MODALIT√Ä DUBBIO: Trascina per misurare (Perpendicolare)</div>
        <canvas id="cvs" style="display:none;"></canvas>
    </div>

    <div id="modalOverlay">
        <div id="modalBox">
            <h3>Calibrazione</h3>
            <div class="modal-section">
                <h4>Metodo 1: FOV</h4>
