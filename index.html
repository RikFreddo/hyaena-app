<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hyaena</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e3dac9">
    <link rel="apple-touch-icon" href="icon.png">

    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <div id="mainMenu">
        <img src="icon.png" alt="Icon" class="app-logo">
        <div class="app-title">Hyaena</div>

        <button class="menu-btn" onclick="startApp()"><span>â¤</span> Start New Session</button>
        <button class="menu-btn secondary" onclick="triggerLoadProject()"><span>ğŸ“‚</span> Load/Import Project</button>
        <button class="menu-btn secondary" onclick="toggleSettings()"><span>âš™ï¸</span> Settings</button>

        <div id="settingsPanel">
            <div style="font-weight:bold; margin-bottom:10px;">Appearance</div>
            <div class="theme-opt" onclick="setTheme('light')" id="themeLight">â˜€ï¸ Light</div>
            <div class="theme-opt" onclick="setTheme('dark')" id="themeDark">ğŸŒ™ Dark</div>
            <div class="theme-opt" onclick="setTheme('auto')" id="themeAuto">ğŸ”„ Auto (System)</div>
            <button class="btn btn-blue" style="width:100%; margin-top:10px;" onclick="toggleSettings()">Done</button>
        </div>

        <div class="version-footer">Version 0.25.4 (Refactored Modular)</div>
    </div>

    <div id="mainContainer">

        <div id="sidebar">
            <div id="projectHeader">
                <div style="font-size:10px; color:var(--text-sec); margin-bottom:2px;">CURRENT PROJECT</div>
                <div id="projectTitleRow">
                    <span id="projNameDisplay">Project_Results</span>
                    <button class="btn-icon-small" onclick="renameProject()" title="Rename Project">âœ</button>
                </div>
            </div>
            <div id="samplesHeader">
                <span>Samples</span>
                <div style="display:flex; gap:5px;">
                    <button class="btn-mini" onclick="sortSamplesAZ()" title="Sort AZ inside groups">AZ</button>
                    <button class="btn-mini" onclick="createNewSample(true)">+ NEW</button>
                    <button class="btn" style="padding:2px 6px; font-size:14px;" onclick="toggleSidebarFullscreen()"
                        title="Expand">â¤¢</button>
                </div>
            </div>
            <ul id="sampleList"></ul>
        </div>

        <div id="workArea">
            <div id="toolbar">
                <!-- ROW 1: HEADER (Menu | Title | Output) -->
                <div class="header-row">
                    <div class="header-left">
                        <div class="dropdown">
                            <button class="btn" onclick="toggleDropdown('menuDropdown')">â‰¡ Menu</button>
                            <div id="menuDropdown" class="dropdown-content">
                                <div onclick="toggleSidebar()">â—« Show/Hide List</div>
                                <label for="inpFile">ğŸ“· Load Image</label>
                                <label for="inpProject">ğŸ“‚ Import Project</label>
                                <div onclick="openImportModal()">ğŸ“‚ Batch Import Samples</div>
                                <div onclick="saveSingleSample()">ğŸ’¾ Save Sample (.json)</div>
                                <div onclick="saveProject()">ğŸ“š Save Project (.json)</div>
                                <div onclick="showMainMenu()">âŒ Close Session</div>
                            </div>
                        </div>
                        <input type="file" id="inpFile" accept="image/*" style="display:none">
                        <input type="file" id="inpProject" accept=".json" multiple style="display:none">
                    </div>

                    <div class="header-center" id="headerTitle">
                        Project_Results
                    </div>

                    <div class="header-right">
                        <button class="btn btn-excel" onclick="openStatsModal()">ğŸ“Š Stats</button>
                        <div class="dropdown">
                            <button class="btn btn-blue" onclick="toggleDropdown('exportDropdown')">â¬‡ Export â–¾</button>
                            <div id="exportDropdown" class="dropdown-content">
                                <div onclick="exportExcel('COUNTS')">ğŸ”¢ Excel (Counts)</div>
                                <div onclick="exportExcel('STATS')">ğŸ“Š Excel (Stats)</div>
                                <div onclick="exportExcel('FULL')">ğŸ“‘ Excel (Complete)</div>
                                <div style="border-top:1px solid #444; margin-top:5px"></div>
                                <div onclick="downloadImg()">ğŸ–¼ï¸ Image (JPG)</div>
                                <div onclick="downloadImgWithCounts()">ğŸ“¸ Image + Overlay</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ROW 2: TOOLS (Centered) -->
                <div class="tools-container">
                    <button class="btn btn-calib" onclick="openCalibration()">ğŸ“ Calib</button>
                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>

                    <div id="zoomContainer" style="background:none; border:none; padding:0;">
                        <button class="btn btn-zoom" onclick="changeZoom(-10)">-</button>
                        <input type="range" id="zoomSlider" min="10" max="400" value="100"
                            oninput="updateZoom(this.value)">
                        <button class="btn btn-zoom" onclick="changeZoom(10)">+</button>
                        <span id="zoomLabel" style="font-size:11px; width:35px; text-align:right;">100%</span>
                        <button class="btn" style="padding:4px 8px; font-size:11px;"
                            onclick="fitToScreen()">Fit</button>
                    </div>

                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
                    <button id="btnPan" class="btn active" onclick="setMode('pan')">âœ‹ Pan</button>
                    <button id="btnSelect" class="btn" onclick="setMode('select')">ğŸ‘† Edit</button>
                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
                    <button id="btnDoubtMode" class="btn btn-doubt-mode" onclick="toggleDoubtMode()">âš ï¸ Doubt</button>
                </div>

                <!-- ROW 3: DRAWING TOOLS (Untouched) -->
                <div class="row" id="toolsRow" style="padding:8px;">
                    <button id="toolLineFs" class="btn active" onclick="setDrawTool('line_fs')"
                        style="border-left:5px solid #ff3b30">ğŸ“ Scratches</button>
                    <button id="toolSp" class="btn" onclick="setDrawTool('point_sp')"
                        style="border-left:5px solid #007aff">ğŸ”µ Sp</button>
                    <button id="toolPp" class="btn" onclick="setDrawTool('point_pp')"
                        style="border-left:5px solid #ff9500">ğŸŸ  Pp</button>
                    <button id="toolCircle" class="btn" onclick="setDrawTool('circle_auto')"
                        style="border-left:5px solid #555">â­• Auto</button>
                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
                    <button id="btnMarkDoubt" class="btn btn-mark-doubt" onclick="markSelectedAsDoubt()"
                        style="display:none;">â“ Mark</button>
                    <button id="btnDelete" class="btn btn-red" onclick="deleteSelected()" style="display:none;">ğŸ—‘ï¸
                        Del</button>
                    <button class="btn" onclick="undo()" id="btnUndo">â†© Undo</button>
                    <button class="btn" onclick="redo()" id="btnRedo">â†ª Redo</button>
                </div>
            </div>

            <div id="stats-bar">Load photo to start.</div>

            <div id="viewport" class="mode-pan">
                <div id="doubtOverlayMsg">âš ï¸ DOUBT MODE: Drag to measure (Perpendicular)</div>
                <div id="noImageMsg" onclick="document.getElementById('inpFile').click()">
                    ğŸ–¼ï¸ No Image Loaded<br>Click here to select photo for<br><span id="msgSampleName">this sample</span>
                </div>
                <canvas id="cvs" style="display:none;"></canvas>
            </div>
        </div>
    </div>

    <div id="modalOverlay">
        <div id="modalBox">
            <h3>Calibration</h3>
            <div class="modal-section">
                <h4>Method 1: FOV</h4>
                <input type="number" id="fovInput" class="inp-num" placeholder="Ex. 500">
                <select id="fovUnit" class="inp-sel">
                    <option value="Âµm">Âµm</option>
                    <option value="mm">mm</option>
                </select>
                <br><br><button class="btn btn-blue" onclick="applyFOV()">Apply</button>
            </div>
            <div class="modal-section" style="border-bottom:none;">
                <h4>Method 2: Manual</h4>
                <button class="btn" onclick="startMeasureRef()">ğŸ“ Pick 2 points</button>
                <br><br>
                <div id="manualInputArea" style="opacity:0.5; pointer-events:none;">
                    <span id="pixelReadout" style="font-size:11px; font-weight:bold;">px: 0</span><br>
                    <input type="number" id="manInput" class="inp-num" placeholder="Dist.">
                    <select id="manUnit" class="inp-sel">
                        <option value="Âµm">Âµm</option>
                        <option value="mm">mm</option>
                    </select>
                    <br><br><button class="btn btn-blue" onclick="applyManual()">Apply Manual</button>
                </div>
            </div>
            <button class="btn btn-red" onclick="closeModal()" style="width:100%">Close</button>
        </div>
    </div>

    <!-- Batch Import Modal -->
    <div id="importModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:4000; justify-content:center; align-items:center;">
        <div
            style="background:var(--modal-bg); color:var(--text-main); padding:20px; border-radius:12px; width:95%; max-width:500px; display:flex; flex-direction:column; max-height:80vh;">
            <h3 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px;">Batch Import (Staging)
            </h3>
            <div style="margin-bottom:15px; display:flex; flex-direction:column; gap:10px;">
                <p style="font-size:13px; color:var(--text-sec); margin:0;">Select JSON files from any folder. They will
                    queue here.</p>
                <button class="btn btn-blue" style="justify-content:center;"
                    onclick="document.getElementById('inpBatchJSON').click()">ğŸ“‚ Browse Files...</button>
                <input type="file" id="inpBatchJSON" accept=".json" multiple style="display:none"
                    onchange="handleBatchSelect(this)">
            </div>

            <div
                style="flex-grow:1; overflow-y:auto; border:1px solid var(--border); border-radius:6px; margin-bottom:15px; background:var(--bg-sidebar);">
                <ul id="stagedFilesList" style="list-style:none; padding:0; margin:0;">
                    <!-- Staged items go here -->
                </ul>
            </div>

            <div style="display:flex; justify-content:space-between; gap:10px;">
                <button class="btn" onclick="closeImportModal()">Cancel</button>
                <button class="btn btn-green" id="btnImportAll" onclick="importAllStaged()" disabled>âœ… Import
                    All</button>
            </div>
        </div>
    </div>

    <!-- Group Selection Modal -->
    <div id="groupSelectionModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:4500; justify-content:center; align-items:center;">
        <div
            style="background:var(--modal-bg); color:var(--text-main); padding:24px; border-radius:16px; width:90%; max-width:320px; box-shadow:0 15px 40px rgba(0,0,0,0.4);">
            <h3 style="margin-top:0; margin-bottom:20px; text-align:center;">New Sample</h3>

            <div style="margin-bottom:15px; text-align:left;">
                <label
                    style="display:block; font-size:11px; font-weight:bold; color:var(--text-sec); margin-bottom:4px; text-transform:uppercase;">Sample
                    Name</label>
                <input type="text" id="newSampleNameInput" class="inp-text-wide" placeholder="Sample Name">
            </div>

            <div style="margin-bottom:25px; text-align:left;">
                <label
                    style="display:block; font-size:11px; font-weight:bold; color:var(--text-sec); margin-bottom:4px; text-transform:uppercase;">Assign
                    to Group</label>
                <select id="groupSelectDropdown" class="inp-sel-wide" onchange="handleGroupSelectChange()">
                    <!-- Options populated by JS -->
                </select>
                <input type="text" id="newGroupNameInput" class="inp-text-wide" style="display:none; margin-top:8px;"
                    placeholder="New Group Name">
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn" onclick="closeGroupModal()">Cancel</button>
                <button class="btn btn-blue" onclick="confirmCreateSample()"
                    style="flex-grow:1; justify-content:center;">Create</button>
            </div>
        </div>
    </div>

    <!-- Generic Custom Dialog -->
    <div id="dialogOverlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:5000; justify-content:center; align-items:center;">
        <div id="dialogBox"
            style="background:var(--modal-bg); color:var(--text-main); padding:24px; border-radius:16px; width:90%; max-width:400px; box-shadow:0 15px 40px rgba(0,0,0,0.4); display:flex; flex-direction:column; gap:16px; text-align:center;">
            <h3 id="dialogTitle" style="margin:0; font-size:20px;">Title</h3>
            <div id="dialogMessage" style="font-size:15px; line-height:1.5; color:var(--text-sec);">Message content
                here.</div>
            <div id="dialogContent" style="width:100%;"></div> <!-- Container for custom inputs if needed -->
            <div id="dialogButtons" style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
                <!-- Buttons injected here -->
            </div>
        </div>
    </div>

    <!-- Advanced Stats & Export Modal -->
    <div id="statsModalOverlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2100; justify-content:center; align-items:center;">
        <div
            style="background:var(--modal-bg); color:var(--text-main); padding:20px; border-radius:12px; width:95%; max-width:400px; max-height:90%; overflow-y:auto; box-shadow:0 10px 25px rgba(0,0,0,0.3); display:flex; flex-direction:column;">
            <h3 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px;">Advanced Statistics
            </h3>
            <div id="statsContent"
                style="font-size:13px; line-height:1.6; flex-grow:1; overflow-y:auto; margin-bottom:15px;"></div>

            <h4 style="margin:10px 0 10px 0; border-top:1px solid var(--border); padding-top:10px;">Export Data</h4>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <button class="btn btn-blue" style="justify-content:center; padding:10px;"
                    onclick="exportExcel('COUNTS')">1. Counts Only</button>
                <button class="btn btn-purple" style="justify-content:center; padding:10px;"
                    onclick="exportExcel('STATS')">2. Adv. Stats Only</button>
                <button class="btn btn-green" style="justify-content:center; padding:10px;"
                    onclick="exportExcel('FULL')">3. Complete (All)</button>
            </div>
            <br>
            <button class="btn btn-red" onclick="document.getElementById('statsModalOverlay').style.display='none'"
                style="width:100%">Close</button>
        </div>
    </div>

    <!-- CORE SCRIPTS (Global Scope) -->
    <script src="js/utils.js"></script>
    <script src="js/statistics.js"></script>

    <!-- NEW MODULES (Loaded individually while keeping global scope) -->
    <script type="module">
        import * as Consts from './js/consts.js';
        // We attach them to window in consts.js, but imports are needed to execute the file
    </script>

    <!-- We load these as regular scripts to ensure they execute in global scope context 
         since we wrote them to attach to window. -->
    <script src="js/consts.js" type="module"></script>
    <script src="js/state.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/canvas.js"></script>
    <script src="js/project.js"></script>
    <script src="js/io.js"></script>
    <script src="js/app.js"></script>

</body>

</html>